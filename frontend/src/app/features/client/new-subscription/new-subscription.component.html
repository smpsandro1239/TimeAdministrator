<div class="new-subscription-container">
  <div class="header">
    <h1>{{ selectedPlan ? 'Finalize o seu Pagamento' : 'Escolha o seu Plano' }}</h1>
    <p *ngIf="!selectedPlan">Selecione o plano que melhor se adapta às suas necessidades.</p>
    <p *ngIf="selectedPlan">Está a um passo de ativar a sua subscrição <strong>{{ selectedPlan.name }}</strong>.</p>
  </div>

  <!-- Secção de Planos (visível se nenhum plano for selecionado) -->
  <div class="plans-grid" *ngIf="!selectedPlan">
    <mat-card *ngFor="let plan of plans" class="plan-card">
      <mat-card-header>
        <mat-card-title>{{ plan.name }}</mat-card-title>
        <mat-card-subtitle *ngIf="plan.discount" class="discount-badge">{{ plan.discount }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="price-container">
          <span class="price">{{ plan.price | currency:'EUR' }}</span>
        </div>
        <p class="description">{{ plan.description }}</p>
      </mat-card-content>
      <mat-card-actions>
        <button mat-raised-button color="primary" (click)="selectPlan(plan)" [disabled]="isLoading" class="select-button">
          Selecionar Plano
        </button>
      </mat-card-actions>
    </mat-card>
  </div>

  <!-- Secção de Pagamento (visível após selecionar um plano) -->
  <div class="payment-section" *ngIf="selectedPlan">
    <div class="loading-overlay" *ngIf="isLoading">
      <mat-spinner></mat-spinner>
      <p>A preparar o seu pagamento seguro...</p>
    </div>

    <div [hidden]="isLoading">
      <!-- O elemento do Stripe será montado aqui -->
      <div id="payment-element" #paymentElement></div>

      <button
        mat-raised-button
        color="primary"
        class="pay-button"
        (click)="processPayment()"
        [disabled]="isProcessingPayment">
        <mat-spinner *ngIf="isProcessingPayment" diameter="20"></mat-spinner>
        <span *ngIf="!isProcessingPayment">Pagar {{ selectedPlan.price | currency:'EUR' }}</span>
      </button>
    </div>
  </div>

  <div class="payment-info">
    <mat-icon>lock</mat-icon>
    <span>Pagamentos seguros processados via <strong>Stripe</strong>.</span>
  </div>
</div>
